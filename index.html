<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>YASSER BOT â€” Ù…Ù„ÙŠÙˆÙ† Ø±Ø¯ Ø°ÙƒÙŠ</title>
  <meta name="theme-color" content="#0ea5e9" />
  <style>
    :root{
      --bg:#0b1220; --panel:#0f172a; --text:#e5e7eb; --muted:#94a3b8;
      --primary:#0ea5e9; --accent:#22d3ee; --user:#2563eb; --bot:#1f2937;
      --glass:rgba(255,255,255,0.06); --glassBorder:rgba(255,255,255,0.12);
    }
    :root.theme-yellow{
      --bg:#0a0a06; --panel:#14140a; --text:#fffbe6; --muted:#f7e8a1;
      --primary:#f5c518; --accent:#ffd65b; --user:#f5c518; --bot:#2a240f;
      --glass:rgba(245,197,24,0.10); --glassBorder:rgba(245,197,24,0.25);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,"Noto Sans Arabic",Segoe UI,Roboto,sans-serif;
      background:linear-gradient(160deg,var(--bg),var(--panel)); color:var(--text);
      display:flex; align-items:center; justify-content:center;
    }
    .app{
      width:min(1200px,96vw); height:min(92vh,920px);
      display:grid; grid-template-columns:360px 1fr; gap:14px;
      padding:18px; border-radius:18px;
      background:linear-gradient(180deg, var(--glass), rgba(255,255,255,0.03));
      border:1px solid var(--glassBorder);
      backdrop-filter:blur(12px) saturate(1.1);
      box-shadow:0 25px 60px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.07);
    }
    .sidebar, .main{
      background:var(--glass); border:1px solid var(--glassBorder);
      border-radius:16px;
    }
    .sidebar{padding:14px; display:flex; flex-direction:column; gap:12px; overflow:auto}
    .brand{display:flex; align-items:center; gap:12px}
    .logo{
      width:44px; height:44px; border-radius:12px;
      background:conic-gradient(from 210deg,var(--primary),var(--accent),#6366f1,var(--primary));
      box-shadow:0 6px 20px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.35);
    }
    .title{font-weight:800; letter-spacing:.2px}
    .muted{color:var(--muted); font-size:.92rem}
    .controls{display:flex; gap:8px; flex-wrap:wrap}
    .btn{
      appearance:none; border:1px solid var(--glassBorder); outline:none; cursor:pointer;
      padding:10px 12px; border-radius:10px; font-weight:700; color:white;
      background:linear-gradient(180deg,var(--primary),#2563eb);
      transition:transform .12s ease, filter .2s ease;
    }
    .btn:hover{transform:translateY(-1px); filter:saturate(1.06)}
    .btn.secondary{background:linear-gradient(180deg,#1f2937,var(--panel))}
    .select,.input{
      width:100%; background:rgba(2,6,23,0.45); color:var(--text);
      border:1px solid var(--glassBorder); border-radius:10px; padding:10px;
      backdrop-filter:blur(6px);
    }
    .badge{
      display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px;
      background:rgba(34,197,94,0.12); color:#a7f3d0; border:1px dashed rgba(34,197,94,0.35); font-weight:700;
    }
    .badge.warn{background:rgba(245,158,11,0.12); color:#fde68a; border-color:rgba(245,158,11,0.35)}
    .modeRow{display:flex; gap:8px; flex-wrap:wrap}
    .main{display:flex; flex-direction:column}
    .messages{flex:1; overflow:auto; padding:16px}
    .bubble{
      max-width:72%; margin:6px 0; padding:12px; border-radius:12px; white-space:pre-wrap;
      background:rgba(255,255,255,0.08); border:1px solid var(--glassBorder);
      box-shadow:0 8px 24px rgba(0,0,0,0.25);
    }
    .bubble.user{background:linear-gradient(180deg,var(--user),#1e40af); margin-left:auto}
    .bubble.bot{background:linear-gradient(180deg,var(--bot),#111827); margin-right:auto}
    .composer{
      display:flex; gap:10px; padding:12px; border-top:1px solid var(--glassBorder);
      background:linear-gradient(180deg, rgba(0,0,0,0.15), rgba(0,0,0,0.25)); backdrop-filter:blur(6px);
    }
    textarea{
      flex:1; resize:none; min-height:48px; max-height:180px; padding:10px;
      border-radius:10px; border:1px solid var(--glassBorder);
      background:rgba(2,6,23,0.45); color:var(--text);
    }
    .code{
      margin-top:10px; padding:10px; border-radius:10px;
      background:rgba(2,6,23,0.6); border:1px solid var(--glassBorder);
      font-family:ui-monospace,Menlo,Consolas,monospace; overflow:auto;
    }
    .small{font-size:.92rem}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:rgba(96,165,250,0.12);color:#bfdbfe;border:1px dashed rgba(96,165,250,0.35);font-weight:700}
    @media (max-width:980px){
      .app{grid-template-columns:1fr; height:95vh}
      .sidebar{order:2}
      .main{order:1}
    }
  </style>
</head>
<body>
  <div class="app" id="appRoot" aria-live="polite">
    <aside class="sidebar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <div class="title">YASSER BOT â€” Ù…Ù„ÙŠÙˆÙ† Ø±Ø¯ Ø°ÙƒÙŠ</div>
          <div class="muted">ÙˆØ§Ø¬Ù‡Ø© Ø²Ø¬Ø§Ø¬ÙŠØ© Ø£Ù†ÙŠÙ‚Ø© Â· PWA Â· Ø±Ø¯ÙˆØ¯ Ù…ÙˆØ³ÙˆØ¹ÙŠØ©</div>
        </div>
      </div>

      <div class="controls">
        <button id="installBtn" class="btn" style="display:none">ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</button>
        <button id="downloadBtn" class="btn secondary">ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©</button>
      </div>

      <label class="small">Ø§Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</label>
      <select id="domainSelect" class="select" aria-label="Ø§Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ">
        <option value="">ØªÙ„Ù‚Ø§Ø¦ÙŠ</option>
        <option>Ø¨Ø±Ù…Ø¬Ø©</option>
        <option>ØªØ´ÙÙŠØ±</option>
        <option>Ø´Ø¨ÙƒØ§Øª</option>
        <option>Ù‚ÙˆØ§Ø¹Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</option>
        <option>Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</option>
        <option>Ù‡Ù†Ø¯Ø³Ø© Ø¨Ø±Ù…Ø¬ÙŠØ§Øª</option>
        <option>Ø£Ù…Ù† Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</option>
        <option>Ø³Ø­Ø§Ø¨Ø©</option>
        <option>Ø£Ù†Ø¸Ù…Ø©</option>
        <option>ÙˆØ§Ø¬Ù‡Ø§Øª ÙˆØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</option>
        <option>Ù‡Ø²Ø§Ø±</option>
        <option>Ø§Ø®ØªØ±Ø§Ù‚</option>
      </select>

      <label class="small">Ø£Ø³Ù„ÙˆØ¨ Ø§Ù„Ø±Ø¯</label>
      <select id="styleSelect" class="select" aria-label="Ø£Ø³Ù„ÙˆØ¨ Ø§Ù„Ø±Ø¯">
        <option value="Ù…Ø®ØªØµØ±">Ù…Ø®ØªØµØ±</option>
        <option value="Ù…ÙØµÙ„">Ù…ÙØµÙ„</option>
        <option value="ØªÙ‚Ù†ÙŠ">ØªÙ‚Ù†ÙŠ</option>
        <option value="ØªØ¹Ù„ÙŠÙ…ÙŠ">ØªØ¹Ù„ÙŠÙ…ÙŠ</option>
        <option value="Ù‚Ø§Ø¦Ù…Ø© Ù†Ù‚Ø§Ø·">Ù‚Ø§Ø¦Ù…Ø© Ù†Ù‚Ø§Ø·</option>
      </select>

      <label class="small">Ø¥Ø¶Ø§ÙØ© Ø£ÙƒÙˆØ§Ø¯ Ø¨Ø±Ù…Ø¬ÙŠØ©</label>
      <select id="codeSelect" class="select" aria-label="Ø¥Ø¶Ø§ÙØ© Ø£ÙƒÙˆØ§Ø¯">
        <option value="Ù„Ø§">Ù„Ø§</option>
        <option value="JavaScript">JavaScript</option>
        <option value="Python">Python</option>
        <option value="C#">C#</option>
        <option value="SQL">SQL</option>
        <option value="Shell">Shell</option>
      </select>

      <div class="modeRow" aria-hidden="false">
        <span class="pill">ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹</span>
        <button id="modeDarkBtn" class="btn">Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ</button>
        <button id="modeYellowBtn" class="btn secondary">Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø£ØµÙØ± Ø§Ù„Ø²Ø¬Ø§Ø¬ÙŠ</button>
      </div>

      <div class="badge" id="capBadge">ÙØ¶Ø§Ø¡ ØªÙˆÙ„ÙŠØ¯: ~1,000,000 Ø±Ø¯ Ù…Ù…ÙƒÙ†</div>
      <div class="badge warn" id="countBadge">Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: 0 Ø±Ø¯</div>

      <div class="muted small">
        Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù€ "Ø§Ù„Ø§Ø®ØªØ±Ø§Ù‚" Ø³ØªÙƒÙˆÙ† ØªÙˆØ¹ÙˆÙŠØ© ÙˆÙ…Ø³Ø¤ÙˆÙ„Ø© ÙÙ‚Ø·ØŒ Ù„Ø§ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø¹Ù…Ù„ÙŠØ©.
      </div>
    </aside>

    <main class="main">
      <div id="messages" class="messages" role="log" aria-live="polite"></div>
      <div class="composer">
        <textarea id="input" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§..." aria-label="Ø­Ù‚Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©"></textarea>
        <button id="sendBtn" class="btn">Ø¥Ø±Ø³Ø§Ù„</button>
      </div>
    </main>
  </div>

<script>
/* YASSER BOT â€” Ù†Ø³Ø®Ø© Ø¬Ø¯ÙŠØ¯Ø© ÙƒØ§Ù…Ù„Ø© ÙÙŠ Ù…Ù„Ù ÙˆØ§Ø­Ø¯
   - Ø²Ø± Ø¥Ø±Ø³Ø§Ù„ Ø´ØºØ§Ù„
   - Ø²Ø± ØªØ«Ø¨ÙŠØª ÙŠØ¸Ù‡Ø± Ø¹Ù†Ø¯ beforeinstallprompt
   - ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø´ØºØ§Ù„
   - ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø´ØºØ§Ù„
   - Ø±Ø¯ÙˆØ¯ Ø°ÙƒÙŠØ© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªÙˆÙ„ÙŠØ¯ Ø­ØªÙ‰ 1,000,000 Ø¹Ø¨Ø± Ù…Ø²Ø¬ Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨
   - Ø­Ù…Ø§ÙŠØ©: Ù„Ø§ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ø®ØªØ±Ø§Ù‚ Ø¹Ù…Ù„ÙŠØ©
*/

document.addEventListener('DOMContentLoaded', function () {
  // Ø¹Ù†Ø§ØµØ± DOM
  const installBtn = document.getElementById('installBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const modeDarkBtn = document.getElementById('modeDarkBtn');
  const modeYellowBtn = document.getElementById('modeYellowBtn');
  const sendBtn = document.getElementById('sendBtn');
  const inputEl = document.getElementById('input');
  const messagesEl = document.getElementById('messages');
  const domainSelect = document.getElementById('domainSelect');
  const styleSelect = document.getElementById('styleSelect');
  const codeSelect = document.getElementById('codeSelect');
  const countBadge = document.getElementById('countBadge');

  let sessionCount = 0;
  let deferredPrompt = null;

  // Ù…Ø¬Ø§Ù„Ø§Øª ÙˆÙƒÙ„Ù…Ø§Øª Ù…ÙØªØ§Ø­ÙŠØ©
  const DOMAINS = {
    "Ø¨Ø±Ù…Ø¬Ø©": ["javascript","python","c#","rust","go","oop","fp","patterns","testing","pwa"],
    "ØªØ´ÙÙŠØ±": ["aes","chacha","rsa","ecc","ed25519","sha","argon2","hkdf","nonce","tls"],
    "Ø´Ø¨ÙƒØ§Øª": ["tcp","udp","http/2","http/3","quic","dns","cdn","proxy","load balancer","socket"],
    "Ù‚ÙˆØ§Ø¹Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª": ["postgresql","mysql","mongodb","index","acid","transactions","sharding","replication","query plan","cache"],
    "Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ": ["cnn","rnn","transformer","attention","embeddings","rl","prompt","fine-tune","inference","latency"],
    "Ù‡Ù†Ø¯Ø³Ø© Ø¨Ø±Ù…Ø¬ÙŠØ§Øª": ["solid","clean architecture","ddd","cqrs","microservices","monolith","refactor","devops","ci/cd"],
    "Ø£Ù…Ù† Ù…Ø¹Ù„ÙˆÙ…Ø§Øª": ["threat model","zero trust","waf","iam","sso","least privilege","audit","key rotation","secrets","encryption"],
    "Ø³Ø­Ø§Ø¨Ø©": ["aws","azure","gcp","kubernetes","docker","serverless","lambda","api gateway","s3","blob"],
    "Ø£Ù†Ø¸Ù…Ø©": ["linux","windows","syscall","process","thread","memory","filesystem","io","kernel","scheduling"],
    "ÙˆØ§Ø¬Ù‡Ø§Øª ÙˆØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…": ["accessibility","design system","typography","animations","dark mode","color contrast","usability","a/b"],
    "Ù‡Ø²Ø§Ø±": ["Ù†ÙƒØªØ©","Ù…Ø²Ø­Ø©","Ù…ÙˆÙ‚Ù Ø·Ø±ÙŠÙ","Ù†ÙƒØªØ© ØªÙ‚Ù†ÙŠØ©","Ø¶Ø­Ùƒ"],
    "Ø§Ø®ØªØ±Ø§Ù‚": ["Ù…Ø³Ø¤ÙˆÙ„ÙŠØ©","ØªÙˆØ¹ÙŠØ©","Ø­Ù…Ø§ÙŠØ©","Ø§Ø®ØªØ¨Ø§Ø± Ø§Ø®ØªØ±Ø§Ù‚","ethical"]
  };

  const TEMPLATES = {
    intro: ["Ù…Ù„Ø®Øµ Ø³Ø±ÙŠØ¹: ","ØªÙ…Ù‡ÙŠØ¯: ","ÙÙƒØ±Ø© Ø£Ø³Ø§Ø³ÙŠØ©: ","Ø¥Ø·Ø§Ø± Ø§Ù„ÙÙ‡Ù…: ","Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„ÙƒØ¨ÙŠØ±Ø©: "],
    details: ["Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙ‚Ù†ÙŠØ©","Ø§Ù„Ø¬ÙˆØ§Ù†Ø¨ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©","Ø£ÙØ¶Ù„ Ø§Ù„Ù…Ù…Ø§Ø±Ø³Ø§Øª","ØªØ­Ø°ÙŠØ±Ø§Øª Ø´Ø§Ø¦Ø¹Ø©","Ø£Ø¯Ø§Ø¡ ÙˆÙ‚ÙŠÙˆØ¯"],
    bullets: ["â€¢ ","â€“ ","* "],
    closers: [
      "Ø®Ù„Ø§ØµØ©: Ø±ÙƒÙ‘Ø² Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø³Ø§Ø·Ø© ÙˆØ§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…ØªÙƒØ±Ø±.",
      "Ø®Ù„Ø§ØµØ©: Ù‚ÙØ³ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ù…Ø¨ÙƒØ±Ù‹Ø§ ÙˆØªØ¬Ù†Ø¨ Ø§Ù„ØªØ¹Ù‚ÙŠØ¯ ØºÙŠØ± Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠ.",
      "Ø®Ù„Ø§ØµØ©: Ø£ÙÙ…ÙÙ‘Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§ÙØµÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¨ØµØ±Ø§Ù…Ø©.",
      "Ø®Ù„Ø§ØµØ©: ÙˆØ«Ù‘Ù‚ Ø§Ù„Ù‚Ø±Ø§Ø±Ø§Øª ÙˆØ±Ø§Ù‚Ø¨ Ø§Ù„Ø¥Ù†ØªØ§Ø¬ Ø¬ÙŠØ¯Ù‹Ø§."
    ]
  };

  // ØªÙˆÙ„ÙŠØ¯ Ù…Ù‚ØªØ·ÙØ§Øª ÙƒÙˆØ¯
  function makeCodeSnippet(topic, lang){
    const t = topic || "Example";
    const map = {
      "JavaScript": `// ${t} â€” Ù…Ø«Ø§Ù„ JavaScript\nasync function example(){\n  const encoder = new TextEncoder();\n  const data = encoder.encode("hello");\n  console.log("len:", data.length);\n}\nexample();`,
      "Python": `# ${t} â€” Ù…Ø«Ø§Ù„ Python\ndef example():\n    data = "hello".encode("utf-8")\n    print("len:", len(data))\nexample()`,
      "C#": `// ${t} â€” Ù…Ø«Ø§Ù„ C#\nusing System;\nclass Demo {\n  static void Main(){\n    var data = System.Text.Encoding.UTF8.GetBytes("hello");\n    Console.WriteLine("len: " + data.Length);\n  }\n}`,
      "SQL": `-- ${t} â€” Ù…Ø«Ø§Ù„ SQL\nSELECT name, score\nFROM users\nWHERE score > 90\nORDER BY score DESC;`,
      "Shell": `# ${t} â€” Ù…Ø«Ø§Ù„ Shell\ntext="hello"\necho "${#text}"`
    };
    return map[lang] || "";
  }

  // ÙƒØ´Ù Ø§Ù„Ù…Ø¬Ø§Ù„ ÙˆØ§Ù„Ù…ÙˆØ¶ÙˆØ¹ Ù…Ù† Ø§Ù„Ø³Ø¤Ø§Ù„
  function detectDomainAndTopic(qText){
    const lower = qText.toLowerCase();
    const manual = (domainSelect.value || "").trim();
    if(manual){
      const topics = DOMAINS[manual] || [];
      for(const t of topics){ if(lower.includes(t)) return { domain: manual, topic: t }; }
      return { domain: manual, topic: topics[0] || manual };
    }
    for(const d in DOMAINS){
      for(const t of DOMAINS[d]){
        if(lower.includes(t)) return { domain: d, topic: t };
      }
    }
    return { domain: "Ø¨Ø±Ù…Ø¬Ø©", topic: "patterns" };
  }

  // Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø­Ø³Ø§Ø³ (Ø§Ø®ØªØ±Ø§Ù‚)
  function isSensitive(domain, qText){
    const lower = qText.toLowerCase();
    if(domain === "Ø§Ø®ØªØ±Ø§Ù‚"){
      const badHints = ["Ø§Ø®ØªØ±Ø§Ù‚","ØªÙ‡ÙƒÙŠØ±","exploit","ddos","sql injection","xss","ÙƒØ±Ø§Ùƒ","ÙƒØ³Ø± Ø­Ù…Ø§ÙŠØ©","Ø¨Ø§ÙŠ Ø¨Ø§Ø³"];
      return badHints.some(k=>lower.includes(k));
    }
    return false;
  }

  // Ù‡Ø§Ø´ Ù„Ø¥Ù†ØªØ§Ø¬ Ù…Ø¹Ø±Ù Ø¶Ù…Ù† Ù…Ù„ÙŠÙˆÙ†
  function fingerprint(...parts){
    const s = parts.join("|");
    let h = 2166136261 >>> 0;
    for(let i=0;i<s.length;i++){ h ^= s.charCodeAt(i); h = Math.imul(h, 16777619); }
    return (h % 1000000);
  }

  // ØªÙˆÙ„ÙŠØ¯ Ø±Ø¯ ØºÙ†ÙŠ ÙˆØ¢Ù…Ù†
  function composeRichReply(question){
    const { domain, topic } = detectDomainAndTopic(question);
    const style = styleSelect.value || "Ù…ÙØµÙ„";
    const codeLang = codeSelect.value || "Ù„Ø§";
    const intro = TEMPLATES.intro[Math.floor(Math.random()*TEMPLATES.intro.length)];
    const detailKind = TEMPLATES.details[Math.floor(Math.random()*TEMPLATES.details.length)];
    const bullet = TEMPLATES.bullets[Math.floor(Math.random()*TEMPLATES.bullets.length)];
    const closer = TEMPLATES.closers[Math.floor(Math.random()*TEMPLATES.closers.length)];

    if(isSensitive(domain, question)){
      const safe = `${intro}Ø§Ù„Ù…Ø¬Ø§Ù„: ${domain}. Ù‡Ø°Ø§ Ù…ÙˆØ¶ÙˆØ¹ Ø­Ø³Ø§Ø³Ø› Ø³Ø£Ù‚Ø¯Ù‘Ù… Ø¥Ø±Ø´Ø§Ø¯Ø§Øª ØªÙˆØ¹ÙˆÙŠØ© ÙˆÙ…Ø³Ø¤ÙˆÙ„Ø© ÙÙ‚Ø·:\n${bullet} Ø§ØªØ¨Ø¹ Ø¥Ø·Ø§Ø± Ø§Ø®ØªØ¨Ø§Ø± Ø§Ø®ØªØ±Ø§Ù‚ Ù‚Ø§Ù†ÙˆÙ†ÙŠ ÙˆÙ…ØµØ±Ø­ Ø¨Ù‡.\n${bullet} Ø±ÙƒÙ‘Ø² Ø¹Ù„Ù‰ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ØªÙ‡Ø¯ÙŠØ¯Ø§ØªØŒ Ø§Ù„ØªØµØ­ÙŠØ­ØŒ ÙˆØªØ¹Ø²ÙŠØ² Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©.\n${bullet} Ø§Ø³ØªØ®Ø¯Ù… Ø¨ÙŠØ¦Ø§Øª ØªØ¯Ø±ÙŠØ¨ Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© ÙˆØ£Ø¯ÙˆØ§Øª ØªÙ‚ÙŠÙŠÙ… Ø¢Ù…Ù†Ø©.\n${closer}`;
      const id = fingerprint(question, domain, topic, style, codeLang);
      return { header:`Ø±Ø¯ #${id} â€” Ù…Ø¬Ø§Ù„: ${domain} | Ù…ÙˆØ¶ÙˆØ¹: ${topic} | Ø£Ø³Ù„ÙˆØ¨: ${style}`, text: safe, code: "" };
    }

    const paragraphA = `${intro}${domain} â€” Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹: ${topic}. Ù‡Ø°Ø§ Ø§Ù„Ø±Ø¯ ÙŠÙˆØ§Ø²Ù† Ø¨ÙŠÙ† Ø§Ù„Ù…ÙÙ‡ÙˆÙ… ÙˆØ§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¹Ù…Ù„ÙŠ Ø¨ØµÙˆØ±Ø© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªÙ†ÙÙŠØ°.`;
    const paragraphB = `${detailKind}: Ø­Ø¯Ù‘Ø¯ Ø§Ù„Ù‡Ø¯Ù ÙˆØ§Ù„Ù‚ÙŠÙˆØ¯ØŒ Ø§Ø®ØªØ± Ø§Ù„Ø£Ø¯ÙˆØ§Øª ÙˆØ§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©ØŒ Ø¬Ø±Ù‘Ø¨ Ø¨Ø³Ø±Ø¹Ø©ØŒ Ù‚ÙØ³ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ØŒ ÙˆØ­Ø³Ù‘Ù† ØªØ¯Ø±ÙŠØ¬ÙŠÙ‹Ø§.`;
    const points = [
      `${bullet} Ù„Ù…Ø§Ø°Ø§ ${topic}ØŸ Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø´ÙƒÙ„Ø© Ù…Ø­Ø¯Ø¯Ø© Ø¨ÙƒÙØ§Ø¡Ø© Ø¶Ù…Ù† Ø³ÙŠØ§Ù‚ ÙˆØ§Ø¶Ø­.`,
      `${bullet} Ø®Ø·ÙˆØ§Øª Ø¹Ù…Ù„ÙŠØ©: Ø­Ø¯Ù‘Ø¯ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§ØªØŒ Ø§Ø¹Ø²Ù„ Ø§Ù„ØªØ¹Ù‚ÙŠØ¯ØŒ Ø§Ø®ØªØ¨Ø± Ø§Ù„Ø­Ø¯ÙˆØ¯ØŒ Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø£Ø¯Ø§Ø¡.`,
      `${bullet} Ø£Ø®Ø·Ø§Ø¡ Ø´Ø§Ø¦Ø¹Ø©: ØªØ¬Ø§Ù‡Ù„ Ø§Ù„ØªÙˆØ«ÙŠÙ‚ØŒ Ø¶Ø¹Ù Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø±Ø§Ø±ØŒ ØªØ¹Ù‚ÙŠØ¯ Ù…Ø¨Ø§Ù„Øº ÙÙŠÙ‡.`,
      `${bullet} ØªÙƒØ§Ù…Ù„: Ø§Ø±Ø¨Ø· ${topic} Ù…Ø¹ Ø·Ø¨Ù‚Ø§Øª Ø§Ù„Ø®Ø¯Ù…Ø©ØŒ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚ØªØŒ ÙˆØ§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©.`
    ];

    let body = "";
    if(style === "Ù…Ø®ØªØµØ±"){
      body = `${paragraphA}\n${closer}`;
    } else if(style === "Ù…ÙØµÙ„" || style === "ØªØ¹Ù„ÙŠÙ…ÙŠ"){
      body = `${paragraphA}\n${paragraphB}\n${points.join("\n")}\n${closer}`;
    } else if(style === "ØªÙ‚Ù†ÙŠ"){
      body = `${paragraphA}\n${paragraphB}\n${points.slice(0,3).join("\n")}\n${closer}`;
    } else {
      body = `${paragraphA}\n${points.join("\n")}\n${closer}`;
    }

    if(domain === "Ù‡Ø²Ø§Ø±"){
      body = `${intro}Ø®ÙØ© Ø¸Ù„ ØªÙ‚Ù†ÙŠØ©:\n${bullet} Ù„Ù…Ø§ Ø§Ù„Ø³ÙŠØ±ÙØ± ÙŠÙ‚ÙˆÙ„ "Internal Error" Ù‡Ùˆ Ø¨Ø³ Ù…Ø­ØªØ§Ø¬ Ù‚Ù‡ÙˆØ© â˜•\n${bullet} Ù„Ù…Ø§ Ø§Ù„Ù€ build ÙŠÙ†Ø¬Ø­ Ù…Ù† Ø£ÙˆÙ„ Ù…Ø±Ø©: ØªØ£ÙƒØ¯ Ø¥Ù†Ùƒ Ù…Ø´ ÙÙŠ Simulation ğŸ˜…\n${closer}`;
    }

    const codeBlock = codeLang !== "Ù„Ø§" ? makeCodeSnippet(topic, codeLang) : "";
    const id = fingerprint(question, domain, topic, style, codeLang);
    return { header:`Ø±Ø¯ #${id} â€” Ù…Ø¬Ø§Ù„: ${domain} | Ù…ÙˆØ¶ÙˆØ¹: ${topic} | Ø£Ø³Ù„ÙˆØ¨: ${style}${codeBlock?" | ÙƒÙˆØ¯: "+codeLang:""}`, text: body, code: codeBlock };
  }

  // Ø¥Ø¶Ø§ÙØ© ÙÙ‚Ø§Ø¹Ø© Ù„Ù„Ø±Ø³Ø§Ø¦Ù„
  function addBubble(text, cls, code){
    const div = document.createElement('div');
    div.className = `bubble ${cls}`;
    const lines = text.split('\n');
    const header = lines[0] || "";
    const rest = lines.slice(1).join('\n');
    const headerEl = document.createElement('div');
    headerEl.style.fontWeight = '800';
    headerEl.style.marginBottom = '6px';
    headerEl.textContent = header;
    div.appendChild(headerEl);
    if(rest) {
      const bodyEl = document.createElement('div');
      bodyEl.textContent = rest;
      div.appendChild(bodyEl);
    }
    if(code){
      const pre = document.createElement('pre');
      pre.className = 'code';
      pre.textContent = code;
      div.appendChild(pre);
    }
    messagesEl.appendChild(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©
  function sendMessage(){
    const q = (inputEl.value || "").trim();
    if(!q) return;
    addBubble(`YASSER: ${q}`, 'user');
    inputEl.value = "";
    setTimeout(()=>{
      const r = composeRichReply(q);
      addBubble(`${r.header}\n\n${r.text}`, 'bot', r.code);
      sessionCount++;
      countBadge.textContent = `Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: ${sessionCount} Ø±Ø¯`;
    }, 250);
  }

  // Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
  sendBtn.addEventListener('click', sendMessage);
  inputEl.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }
  });

  modeDarkBtn.addEventListener('click', ()=>{
    document.documentElement.classList.remove('theme-yellow');
  });
  modeYellowBtn.addEventListener('click', ()=>{
    document.documentElement.classList.add('theme-yellow');
  });

  downloadBtn.addEventListener('click', ()=>{
    const html = document.documentElement.outerHTML;
    const blob = new Blob([html], {type:'text/html'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'YASSER-BOT.html';
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });

  // PWA: beforeinstallprompt handling
  window.addEventListener('beforeinstallprompt', (e)=>{
    e.preventDefault();
    deferredPrompt = e;
    installBtn.style.display = 'inline-block';
  });
  installBtn.addEventListener('click', async ()=>{
    if(deferredPrompt){
      deferredPrompt.prompt();
      try{ await deferredPrompt.userChoice; }catch(e){}
      deferredPrompt = null;
      installBtn.style.display = 'none';
    } else {
      alert('Ø¥Ø°Ø§ Ù„Ù… ÙŠØ¸Ù‡Ø± Ø­ÙˆØ§Ø± Ø§Ù„ØªØ«Ø¨ÙŠØªØŒ Ø§Ø³ØªØ®Ø¯Ù… Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµÙØ­ Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.');
    }
  });

  // Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© (Promise)
  function createIcon(size){
    return new Promise((resolve)=>{
      const c = document.createElement('canvas'); c.width = size; c.height = size;
      const ctx = c.getContext('2d');
      const primary = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#0ea5e9';
      const g = ctx.createLinearGradient(0,0,size,size);
      g.addColorStop(0, primary); g.addColorStop(1, '#6366f1');
      ctx.fillStyle = g; ctx.fillRect(0,0,size,size);
      ctx.fillStyle = '#fff'; ctx.font = `${Math.floor(size*0.18)}px sans-serif`; ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.fillText('YASSER', size/2, size/2);
      c.toBlob(function(blob){
        if(blob) resolve(URL.createObjectURL(blob));
        else resolve(null);
      }, 'image/png');
    });
  }

  // Ø¥Ø¹Ø¯Ø§Ø¯ manifest Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ
  async function setupManifest(){
    try{
      const icon192 = await createIcon(192);
      const icon512 = await createIcon(512);
      const manifest = {
        name: "YASSER BOT â€” 1M Replies",
        short_name: "YASSER BOT",
        start_url: "./",
        display: "standalone",
        background_color: "#0f172a",
        theme_color: "#0ea5e9",
        icons: []
      };
      if(icon192) manifest.icons.push({src: icon192, sizes:"192x192", type:"image/png"});
      if(icon512) manifest.icons.push({src: icon512, sizes:"512x512", type:"image/png"});
      const blob = new Blob([JSON.stringify(manifest)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const link = document.createElement('link');
      link.rel = 'manifest'; link.href = url;
      document.head.appendChild(link);
    }catch(e){
      // ØªØ¬Ø§Ù‡Ù„ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©
    }
  }

  // ØªØ³Ø¬ÙŠÙ„ Service Worker Ø¨Ø³ÙŠØ·
  async function setupSW(){
    if(!('serviceWorker' in navigator)) return;
    const swCode = `
      const CACHE='yasser-bot-onefile-v1';
      self.addEventListener('install', e=>{
        e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['./'])));
        self.skipWaiting();
      });
      self.addEventListener('activate', e=>{
        e.waitUntil(caches.keys().then(keys=>Promise.all(keys.filter(k=>k!==CACHE).map(k=>caches.delete(k)))));
        self.clients.claim();
      });
      self.addEventListener('fetch', e=>{
        e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request).then(res=>{ const copy = res.clone(); caches.open(CACHE).then(c=>c.put(e.request, copy)); return res; })));
      });
    `;
    try{
      const blob = new Blob([swCode], {type:'application/javascript'});
      const url = URL.createObjectURL(blob);
      await navigator.serviceWorker.register(url, {scope:'./'});
    }catch(e){
      // ØªØ¬Ø§Ù‡Ù„ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
    }
  }

  // Ø¥Ù‚Ù„Ø§Ø¹
  (async function boot(){
    await setupManifest();
    await setupSW();
    addBubble("Ù…Ø±Ø­Ø¨Ù‹Ø§! Ø£Ù†Ø§ YASSER BOT. Ø§Ø³Ø£Ù„Ù†ÙŠ ÙÙŠ Ø£ÙŠ Ù…Ø¬Ø§Ù„ØŒ ÙˆØ§Ø®ØªØ± Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø°ÙŠ ØªÙØ¶Ù„Ù‡ Ù…Ù† Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ.", "bot");
  })();

}); // DOMContentLoaded
</script>
</body>
</html>
