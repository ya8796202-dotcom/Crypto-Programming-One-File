<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>بوت موسوعي — مليون رد ذكي مع أكواد</title>
  <meta name="theme-color" content="#0ea5e9">
  <style>
    :root{
      --bg:#0b1220; --panel:#0f172a; --text:#e5e7eb; --muted:#94a3b8;
      --primary:#0ea5e9; --accent:#22d3ee; --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444;
      --bot:#1f2937; --user:#2563eb;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,"Noto Sans Arabic",Segoe UI,Roboto,sans-serif;
      background:linear-gradient(160deg,#0b1220,#0f172a); color:var(--text);
      display:flex; align-items:center; justify-content:center;
    }
    .app{
      width:min(1200px,96vw); height:min(90vh,900px);
      display:grid; grid-template-columns:340px 1fr; gap:14px;
      padding:18px; border-radius:18px; background:linear-gradient(180deg,rgba(255,255,255,0.05),rgba(255,255,255,0.02));
      border:1px solid rgba(255,255,255,0.08); backdrop-filter:blur(6px);
      box-shadow:0 25px 60px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.07);
    }
    .sidebar{
      background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.08);
      border-radius:16px; padding:14px; display:flex; flex-direction:column; gap:10px; overflow:auto;
    }
    .brand{display:flex; align-items:center; gap:10px}
    .logo{width:42px; height:42px; border-radius:12px; background:conic-gradient(from 210deg,#0ea5e9,#22d3ee,#6366f1,#0ea5e9)}
    .title{font-weight:800; letter-spacing:.2px}
    .muted{color:var(--muted); font-size:.92rem}
    .pill{
      display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px;
      background:rgba(96,165,250,0.12); color:#bfdbfe; border:1px dashed rgba(96,165,250,0.35); font-weight:700;
    }
    .controls{display:flex; gap:8px; flex-wrap:wrap}
    .btn{
      appearance:none; border:1px solid rgba(255,255,255,0.12); outline:none; cursor:pointer;
      padding:10px 12px; border-radius:10px; font-weight:700; color:white;
      background:linear-gradient(180deg,#0ea5e9,#2563eb); transition:transform .12s ease, filter .2s ease;
    }
    .btn:hover{transform:translateY(-1px); filter:saturate(1.06)}
    .btn.secondary{background:linear-gradient(180deg,#1f2937,#0f172a)}
    .select, .input{
      width:100%; background:rgba(2,6,23,0.6); color:var(--text);
      border:1px solid rgba(255,255,255,0.12); border-radius:10px; padding:10px;
    }
    .stats{display:flex; gap:8px; flex-wrap:wrap}
    .badge{
      display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px;
      background:rgba(34,197,94,0.12); color:#a7f3d0; border:1px dashed rgba(34,197,94,0.35); font-weight:700;
    }
    .badge.warn{background:rgba(245,158,11,0.12); color:#fde68a; border-color:rgba(245,158,11,0.35)}
    .main{
      background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.08);
      border-radius:16px; display:flex; flex-direction:column;
    }
    .messages{flex:1; overflow:auto; padding:16px}
    .bubble{
      max-width:72%; margin:6px 0; padding:12px; border-radius:12px; white-space:pre-wrap;
      background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.08);
    }
    .bubble.user{background:linear-gradient(180deg,#2563eb,#1e40af); margin-left:auto}
    .bubble.bot{background:linear-gradient(180deg,#1f2937,#111827); margin-right:auto}
    .composer{display:flex; gap:10px; padding:12px; border-top:1px solid rgba(255,255,255,0.08); background:rgba(0,0,0,0.2)}
    textarea{
      flex:1; resize:none; min-height:44px; max-height:160px; padding:10px;
      border-radius:10px; border:1px solid rgba(255,255,255,0.12); background:rgba(2,6,23,0.6); color:var(--text);
    }
    .code{
      margin-top:10px; padding:10px; border-radius:10px; background:rgba(2,6,23,0.6); border:1px solid rgba(255,255,255,0.1);
      font-family:ui-monospace,Menlo,Consolas,monospace; overflow:auto;
    }
    .small{font-size:.92rem}
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <div class="title">بوت موسوعي — مليون رد</div>
          <div class="muted">PWA قابل للتثبيت + أوفلاين + أكواد + مجالات متعددة</div>
        </div>
      </div>

      <div class="controls">
        <button id="installBtn" class="btn">تثبيت</button>
        <button id="downloadBtn" class="btn secondary">تنزيل الصفحة</button>
      </div>

      <label class="small">اختر المجال الأساسي</label>
      <select id="domainSelect" class="select">
        <option value="">تلقائي</option>
        <option>برمجة</option>
        <option>تشفير</option>
        <option>شبكات</option>
        <option>قواعد بيانات</option>
        <option>ذكاء اصطناعي</option>
        <option>هندسة برمجيات</option>
        <option>أمن معلومات</option>
        <option>سحابة</option>
        <option>أنظمة</option>
        <option>واجهات وتجربة المستخدم</option>
      </select>

      <label class="small">أسلوب الرد</label>
      <select id="styleSelect" class="select">
        <option value="مختصر">مختصر</option>
        <option value="مفصل">مفصل</option>
        <option value="تقني">تقني</option>
        <option value="تعليمي">تعليمي</option>
        <option value="قائمة نقاط">قائمة نقاط</option>
      </select>

      <label class="small">إضافة أكواد برمجية</label>
      <select id="codeSelect" class="select">
        <option value="لا">لا</option>
        <option value="JavaScript">JavaScript</option>
        <option value="Python">Python</option>
        <option value="C#">C#</option>
        <option value="SQL">SQL</option>
        <option value="Shell">Shell</option>
      </select>

      <div class="stats">
        <span class="badge" id="capBadge">الطاقة النظرية: 1,000,000 رد</span>
        <span class="badge warn" id="countBadge">الجلسة الحالية: 0 رد</span>
      </div>

      <div class="muted small">نصيحة: استخدم كلمات مفتاحية واضحة (مثل "AES-GCM"، "فهرسة PostgreSQL"، "REST vs gRPC"، "CNN vs Transformer") للحصول على ردود دقيقة.</div>
    </aside>

    <main class="main">
      <div id="messages" class="messages"></div>
      <div class="composer">
        <textarea id="input" placeholder="اكتب سؤالك هنا..."></textarea>
        <button id="sendBtn" class="btn">إرسال</button>
      </div>
    </main>
  </div>

<script>
(function(){
  const messagesEl = document.getElementById('messages');
  const inputEl = document.getElementById('input');
  const sendBtn = document.getElementById('sendBtn');
  const countBadge = document.getElementById('countBadge');
  const domainSelect = document.getElementById('domainSelect');
  const styleSelect = document.getElementById('styleSelect');
  const codeSelect = document.getElementById('codeSelect');
  const installBtn = document.getElementById('installBtn');
  const downloadBtn = document.getElementById('downloadBtn');

  let sessionCount = 0;
  let deferredPrompt = null;

  // مفردات/مجالات وكلمات مفتاحية
  const DOMAINS = {
    "برمجة": ["JavaScript","Python","C#","Rust","Go","OOP","FP","Patterns","Testing","PWA"],
    "تشفير": ["AES-GCM","ChaCha20-Poly1305","RSA","ECC","Ed25519","SHA-256","Argon2","HKDF","Nonce","TLS"],
    "شبكات": ["TCP","UDP","HTTP/2","HTTP/3","QUIC","DNS","CDN","Proxy","Load Balancer","Socket"],
    "قواعد بيانات": ["PostgreSQL","MySQL","MongoDB","Index","ACID","Transactions","Sharding","Replication","Query Plan","Cache"],
    "ذكاء اصطناعي": ["CNN","RNN","Transformer","Attention","Embeddings","RL","Prompt","Fine-tune","Inference","Latency"],
    "هندسة برمجيات": ["SOLID","Clean Architecture","DDD","CQRS","Microservices","Monolith","Refactor","Review","DevOps","CI/CD"],
    "أمن معلومات": ["Threat Model","Zero Trust","WAF","IAM","SSO","Least Privilege","Audit","Key Rotation","Secrets","Encryption"],
    "سحابة": ["AWS","Azure","GCP","Kubernetes","Docker","Serverless","Lambda","API Gateway","S3","Blob"],
    "أنظمة": ["Linux","Windows","Syscall","Process","Thread","Memory","Filesystem","I/O","Kernel","Scheduling"],
    "واجهات وتجربة المستخدم": ["Accessibility","Design System","Typography","Animations","Dark Mode","Color Contrast","Fitts","Hick","Usability","A/B"]
  };

  // مصفوفات قوالب توليد الردود (تشكيل مليون رد ممكن عبر المزج)
  const TEMPLATES = {
    intro: [
      "ملخص سريع: ", "نقطة البدء: ", "فكرة أساسية: ", "إطار الفهم: ", "الصورة الكبيرة: "
    ],
    details: [
      "التفاصيل التقنية", "الجوانب العملية", "أفضل الممارسات", "تحذيرات شائعة", "أداء وقيود"
    ],
    bullets: [
      "• ", "– ", "* "
    ],
    closers: [
      "خلاصة: ركّز على البساطة والاختبار المتكرر.",
      "خلاصة: قِس الأداء مبكرًا وتجنب التعقيد غير الضروري.",
      "خلاصة: أَمِّن البيانات وافصل الصلاحيات بصرامة.",
      "خلاصة: وثّق قراراتك التقنية وراقب الإنتاج جيدًا."
    ]
  };

  // توليد أكواد برمجية حسب المجال واللغة
  function makeCodeSnippet(topic, lang){
    const snippets = {
      "JavaScript": `// ${topic} — مثال JavaScript
async function example(){
  const encoder = new TextEncoder();
  const data = encoder.encode("hello");
  // ملاحظة: هذا مثال تعليمي
  console.log("len:", data.length);
}
example();`,
      "Python": `# ${topic} — مثال Python
def example():
    data = "hello".encode("utf-8")
    print("len:", len(data))
example()`,
      "C#": `// ${topic} — مثال C#
using System;
class Demo {
  static void Main(){
    var data = System.Text.Encoding.UTF8.GetBytes("hello");
    Console.WriteLine("len: " + data.Length);
  }
}`,
      "SQL": `-- ${topic} — مثال SQL
SELECT name, score
FROM users
WHERE score > 90
ORDER BY score DESC;`,
      "Shell": `# ${topic} — مثال Shell
text="hello"
echo "${#text}"`
    };
    return snippets[lang] || "";
  }

  // بحث الكلمات المفتاحية لاختيار المجال/الموضوع
  function detectDomainAndTopic(qText){
    const lower = qText.toLowerCase();
    // لو المستخدم اختار مجال يدويًا نعطيه الأولوية
    const manual = domainSelect.value || "";
    if(manual) {
      const topics = DOMAINS[manual];
      for(const t of topics){
        if(lower.includes(t.toLowerCase())) return { domain: manual, topic: t };
      }
      // لم يجد كلمة داخل المجال المختار، نأخذ أول موضوع كافتراضي
      return { domain: manual, topic: topics[0] };
    }
    // تلقائي: امسح كل المجالات
    for(const d in DOMAINS){
      for(const t of DOMAINS[d]){
        if(lower.includes(t.toLowerCase())) return { domain: d, topic: t };
      }
    }
    // إن لم تُكتشف كلمة، اختر مجال عام
    return { domain: "برمجة", topic: "Patterns" };
  }

  // تشكيل رد كبير غني بمحتوى متعدد
  function composeRichReply(question){
    const { domain, topic } = detectDomainAndTopic(question);
    const style = styleSelect.value;
    const codeLang = codeSelect.value;
    const intro = TEMPLATES.intro[Math.floor(Math.random()*TEMPLATES.intro.length)];
    const detailKind = TEMPLATES.details[Math.floor(Math.random()*TEMPLATES.details.length)];
    const bullet = TEMPLATES.bullets[Math.floor(Math.random()*TEMPLATES.bullets.length)];
    const closer = TEMPLATES.closers[Math.floor(Math.random()*TEMPLATES.closers.length)];

    // فقرات أساسية
    const paragraphA = `${intro}${domain} — الموضوع: ${topic}. هذا الرد يوازن بين المفهوم والتطبيق العملي ليعطيك صورة واضحة قابلة للتنفيذ.`;
    const paragraphB = `${detailKind}: ركّز على تحديد الهدف، تقييم القيود، ثم اختيار الأدوات والأنماط المناسبة. جرّب بسرعة، قِس النتائج، وحسّن تدريجيًا.`;

    // نقاط
    const points = [
      `${bullet} لماذا ${topic}؟ لأنه يعالج مشكلة محددة بكفاءة عند استخدامه ضمن سياق واضح.`,
      `${bullet} خطوات عملية: حدّد المدخلات، اعزل التعقيد، اختبر الحدود، راقب الأداء.`,
      `${bullet} أخطاء شائعة: تجاهل تسجيل القرارات، ضعف إدارة المفاتيح/الأسرار، تعقيد مبالغ فيه.`,
      `${bullet} تكامل: اربط ${topic} مع طبقات الخدمة، التخزين المؤقت، والمراقبة في الإنتاج.`
    ];

    // أسلوب الرد
    let body = "";
    if(style === "مختصر"){
      body = `${paragraphA}\n${closer}`;
    } else if(style === "مفصل" || style === "تعليمي"){
      body = `${paragraphA}\n${paragraphB}\n${points.join("\n")}\n${closer}`;
    } else if(style === "تقني"){
      body = `${paragraphA}\n${paragraphB}\n${points.slice(0,3).join("\n")}\n${closer}`;
    } else if(style === "قائمة نقاط"){
      body = `${paragraphA}\n${points.join("\n")}\n${closer}`;
    }

    // كود برمجي اختياري
    let codeBlock = "";
    if(codeLang !== "لا"){
      codeBlock = makeCodeSnippet(topic, codeLang);
    }

    // مُعرّف رد لإتاحة توليد حتى مليون رد (مزج قوالب وكلمات يعطي فضاء كبير)
    const fingerprint = Math.abs(hashString(`${question}|${domain}|${topic}|${style}|${codeLang}|${intro}|${detailKind}|${bullet}|${closer}`));
    const replyHeader = `رد #${fingerprint % 1000000} — مجال: ${domain} | موضوع: ${topic} | أسلوب: ${style}${codeLang!=="لا"?" | كود: "+codeLang:""}`;

    return { header: replyHeader, text: body, code: codeBlock };
  }

  // هاش خفيف للنص
  function hashString(s){
    let h = 2166136261 >>> 0;
    for(let i=0;i<s.length;i++){
      h ^= s.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return h >>> 0;
  }

  // إضافة فقاعة
  function addBubble(text, cls, code){
    const div = document.createElement('div');
    div.className = `bubble ${cls}`;
    div.textContent = text;
    if(code){
      const pre = document.createElement('pre');
      pre.className = 'code';
      pre.textContent = code;
      div.appendChild(pre);
    }
    messagesEl.appendChild(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  // إرسال/رد
  sendBtn.addEventListener('click', ()=>{
    const q = (inputEl.value || "").trim();
    if(!q) return;
    addBubble(q, 'user');
    inputEl.value = "";
    setTimeout(()=>{
      const r = composeRichReply(q);
      addBubble(`${r.header}\n\n${r.text}`, 'bot', r.code);
      sessionCount++;
      countBadge.textContent = `الجلسة الحالية: ${sessionCount} رد`;
    }, 300);
  });

  // اختصارات
  inputEl.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendBtn.click(); }
  });

  // تنزيل الصفحة الحالية
  downloadBtn.addEventListener('click', ()=>{
    const html = document.documentElement.outerHTML;
    const blob = new Blob([html], {type:'text/html'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'encyclopedic-bot.html';
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });

  // تثبيت PWA
  window.addEventListener('beforeinstallprompt', (e)=>{
    e.preventDefault(); deferredPrompt = e; installBtn.style.display='inline-block';
  });
  installBtn.addEventListener('click', async ()=>{
    if(deferredPrompt){ deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; }
    else alert('استخدم زر التثبيت في المتصفح إن لم يظهر الحوار.');
  });

  // أيقونة ديناميكية + Manifest + SW
  async function createIcon(size){
    const c=document.createElement('canvas'); c.width=size; c.height=size;
    const ctx=c.getContext('2d');
    const g=ctx.createLinearGradient(0,0,size,size); g.addColorStop(0,'#0ea5e9'); g.addColorStop(1,'#6366f1');
    ctx.fillStyle=g; ctx.fillRect(0,0,size,size);
    ctx.fillStyle='#fff'; ctx.font=`${Math.floor(size*0.26)}px sans-serif`; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText('BOT', size/2, size/2);
    const b=await new Promise(res=>c.toBlob(res,'image/png')); return URL.createObjectURL(b);
  }
  async function setupManifest(){
    const icon192=await createIcon(192); const icon512=await createIcon(512);
    const manifest={name:"Encyclopedic ChatBot — 1M Replies",short_name:"Bot1M",start_url:"./",display:"standalone",background_color:"#0f172a",theme_color:"#0ea5e9",icons:[{src:icon192,sizes:"192x192",type:"image/png"},{src:icon512,sizes:"512x512",type:"image/png"}]};
    const blob=new Blob([JSON.stringify(manifest)],{type:'application/json'});
    const url=URL.createObjectURL(blob);
    const link=document.createElement('link'); link.rel='manifest'; link.href=url; document.head.appendChild(link);
  }
  async function setupSW(){
    if(!('serviceWorker' in navigator)) return;
    const sw = `
      const CACHE='bot-1m-onefile-v1';
      self.addEventListener('install',e=>{ e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['./']))); self.skipWaiting(); });
      self.addEventListener('activate',e=>{ e.waitUntil(caches.keys().then(keys=>Promise.all(keys.filter(k=>k!==CACHE).map(k=>caches.delete(k))))); self.clients.claim(); });
      self.addEventListener('fetch',e=>{
        e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request).then(res=>{
          const copy=res.clone(); caches.open(CACHE).then(c=>c.put(e.request,copy)); return res;
        })));
      });
    `;
    const blob=new Blob([sw],{type:'application/javascript'});
    const url=URL.createObjectURL(blob);
    navigator.serviceWorker.register(url,{scope:'./'});
  }

  // إقلاع
  (async function boot(){
    await setupManifest();
    await setupSW();
  })();
})();
</script>
</body>
</html>
